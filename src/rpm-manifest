#!/bin/sh

# persistent storage
base_dir="/etc/rpm-manifest"

# file locations
rpms="$base_dir/rpms"
manifest="$base_dir/manifest"
leaves="$base_dir/leaves"

if touch $rpms; then
  rpm -qa --qf "%|epoch?{%{epoch}}:{0}|:%{name}-%{version}-%{release}.%{arch}\n" | sort > $rpms
else
  echo "Error: $rpms not writable" >&2
  exit 1
fi

if [ -r $rpms ]; then
  md5sum < $rpms | awk '{print $1}' > $manifest
else
  echo "Error: $rpms not readable" >&2
  exit 1
fi

if touch $leaves; then
  package-cleanup --leaves | sort > $leaves
else
  echo "Error: $leaves not writable" >&2
  exit 1
fi
